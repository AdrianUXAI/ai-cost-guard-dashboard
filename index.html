<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cost Guard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background-color: #059669; color: white; }
        .btn-primary:hover { background-color: #047857; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-stripe { background-color: #635bff; color: white; }
        .btn-stripe:hover { background-color: #4b45c6; }
        .nav-item { cursor: pointer; padding: 0.5rem 1rem; border-radius: 0.375rem; color: #9ca3af; }
        .nav-item.active { background-color: #374151; color: white; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-5xl mx-auto space-y-6">
        
        <!-- HEADER & NAV -->
        <header class="border-b border-gray-700 pb-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-emerald-400 flex items-center gap-2">
                    <i data-lucide="shield-check"></i> <span data-i18n="app_title">AI Cost Guard</span>
                </h1>
                <p class="text-gray-400 text-sm mt-1"><span data-i18n="user_label">User:</span> <span id="user-id-display" class="font-mono text-yellow-400">Loading...</span></p>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Language Selector -->
                <select id="lang-selector" onchange="changeLanguage(this.value)" class="bg-gray-800 text-white text-sm border border-gray-600 rounded p-1 focus:ring-emerald-500">
                    <option value="en">ðŸ‡ºðŸ‡¸ English</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                    <option value="pt">ðŸ‡§ðŸ‡· PortuguÃªs</option>
                    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                </select>

                <nav class="flex gap-2 bg-gray-800 p-1 rounded-lg">
                    <div id="nav-dashboard" class="nav-item active" onclick="switchTab('dashboard')" data-i18n="nav_dashboard">Dashboard</div>
                    <div id="nav-reports" class="nav-item" onclick="switchTab('reports')" data-i18n="nav_reports">Reports</div>
                    <div id="nav-settings" class="nav-item" onclick="switchTab('settings')" data-i18n="nav_settings">Settings</div>
                </nav>
            </div>
        </header>

        <!-- CONFIG WARNING -->
        <div id="config-warning" class="bg-red-900/50 border border-red-500 p-4 rounded-lg text-red-200 hidden">
            ðŸš¨ <strong>Action Required:</strong> Edit this file and paste your SUPABASE_ANON_KEY in the code below.
        </div>

        <!-- === TAB: DASHBOARD === -->
        <div id="tab-dashboard" class="space-y-6">
            <!-- STATUS PANEL -->
            <div class="card grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <p class="text-sm text-gray-400" data-i18n="monthly_limit">Monthly Limit</p>
                    <div class="flex items-center gap-3 mt-1">
                        <span id="budget-display" class="text-4xl font-bold text-white">---</span>
                        <button onclick="openModal('budget-modal')" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300" data-i18n="edit">Edit</button>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-400" data-i18n="current_spend">Current Spend</p>
                    <p id="spent-display" class="text-4xl font-bold text-emerald-400">$0.00</p>
                </div>
            </div>

            <!-- USAGE METER -->
            <div class="card">
                <div class="flex justify-between mb-2">
                    <span class="text-sm text-gray-400" data-i18n="utilization">Budget Utilization</span>
                    <span id="usage-percent" class="text-sm font-bold text-white">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- TEST INTERFACE -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
                    <i data-lucide="play-circle"></i> <span data-i18n="test_title">Live Proxy Test</span>
                </h2>
                <textarea id="prompt-input" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded p-3 text-white mb-4" placeholder="Ask the AI something..."></textarea>
                <button id="btn-run-test" onclick="runProxyTest()" class="btn btn-primary w-full" data-i18n="run_test">Run Generation</button>
                
                <div class="mt-4 bg-black rounded p-4 font-mono text-xs text-green-400 h-32 overflow-y-auto border border-gray-700" id="console-output">
                    <div class="text-gray-500">> System Ready.</div>
                </div>
            </div>
        </div>

        <!-- === TAB: REPORTS === -->
        <div id="tab-reports" class="space-y-6 hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white" data-i18n="report_title">Client Report Generator</h2>
                    <button onclick="generateGammaReport()" class="btn bg-purple-600 hover:bg-purple-700 text-white flex items-center gap-2">
                        <i data-lucide="copy"></i> <span data-i18n="copy_gamma">Copy for Gamma</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-800 p-4 rounded border border-gray-600">
                        <p class="text-gray-400 text-xs uppercase" data-i18n="total_invest">Total Investment</p>
                        <p id="report-total" class="text-2xl font-bold text-white">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded border border-gray-600">
                        <p class="text-gray-400 text-xs uppercase" data-i18n="est_savings">Est. Savings</p>
                        <p id="report-savings" class="text-2xl font-bold text-green-400">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded border border-gray-600">
                        <p class="text-gray-400 text-xs uppercase" data-i18n="eff_score">Efficiency Score</p>
                        <p id="report-efficiency" class="text-2xl font-bold text-blue-400">0%</p>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-300 mb-3" data-i18n="recent_trans">Recent Transactions</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-800 text-gray-200 uppercase font-medium">
                            <tr>
                                <th class="px-4 py-3">Date</th>
                                <th class="px-4 py-3">Model</th>
                                <th class="px-4 py-3">Type</th>
                                <th class="px-4 py-3 text-right">Cost</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body" class="divide-y divide-gray-700">
                            <tr><td colspan="4" class="px-4 py-4 text-center">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- === TAB: SETTINGS === -->
        <div id="tab-settings" class="space-y-6 hidden">
            
            <!-- Subscription Card -->
            <div class="card border border-indigo-500/30 bg-indigo-900/10">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="credit-card"></i> <span data-i18n="pro_sub">Pro Subscription</span>
                        </h2>
                        <p class="text-gray-400 text-sm mt-1" data-i18n="pro_desc">Increase limits and unlock advanced analytics.</p>
                    </div>
                    <button onclick="redirectToStripe()" class="btn btn-stripe flex items-center gap-2" data-i18n="upgrade_btn">
                        Upgrade to Pro
                    </button>
                </div>
            </div>

            <!-- Custom Models Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-white" data-i18n="custom_models">Custom Models (Offline/Local)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="model-name" placeholder="Model Name" class="bg-gray-800 border border-gray-600 rounded p-2 text-white">
                    <input type="number" id="model-rate" placeholder="Rate ($)" class="bg-gray-800 border border-gray-600 rounded p-2 text-white">
                    <button onclick="addCustomModel()" class="btn btn-primary" data-i18n="add_model">Add Model</button>
                </div>

                <div id="custom-models-list" class="space-y-2">
                    <!-- Models injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- BUDGET MODAL -->
    <div id="budget-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-sm border border-gray-600">
            <h3 class="text-lg font-bold mb-4" data-i18n="set_budget_title">Set Monthly Budget</h3>
            <input type="number" id="new-budget-input" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white mb-4" placeholder="e.g. 50.00">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('budget-modal')" class="btn btn-secondary">Cancel</button>
                <button onclick="saveBudget()" class="btn btn-primary" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Pre-filled from your project info:
        const SUPABASE_URL = "https://tsogjfhrvzuweshlfrfu.supabase.co";
        const PROXY_URL = "https://tsogjfhrvzuweshlfrfu.supabase.co/functions/v1/ai-proxy";
        const STRIPE_LINK = "https://buy.stripe.com/test_fZu9AV1Ol8Kx1argozfjG00"; 

        // !!! ACTION REQUIRED: PASTE YOUR SUPABASE KEY BELOW !!!
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRzb2dqZmhydnp1d2VzaGxmcmZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyODE0OTIsImV4cCI6MjA3NDg1NzQ5Mn0.X5cOGVh-oNpAsGydbvDiu59FBULi5dr-J6h5Jmwi_To"; 

        // --- 2. STATE ---
        let supabase;
        let userId;
        let currentLimit = 50.00;
        let totalSpent = 0.00;
        let transactions = [];
        
        // Translation Dictionary
        const translations = {
            en: {
                app_title: "AI Cost Guard", user_label: "User:", nav_dashboard: "Dashboard", nav_reports: "Reports", nav_settings: "Settings",
                monthly_limit: "Monthly Limit", edit: "Edit", current_spend: "Current Spend", utilization: "Budget Utilization",
                test_title: "Live Proxy Test", run_test: "Run Generation", report_title: "Client Report Generator", copy_gamma: "Copy for Gamma",
                total_invest: "Total Investment", est_savings: "Est. Savings", eff_score: "Efficiency Score", recent_trans: "Recent Transactions",
                pro_sub: "Pro Subscription", pro_desc: "Increase limits and unlock advanced analytics.", upgrade_btn: "Upgrade to Pro",
                custom_models: "Custom Models (Offline/Local)", add_model: "Add Model", set_budget_title: "Set Monthly Budget", cancel: "Cancel", save: "Save"
            },
            es: {
                app_title: "GuardiÃ¡n de Costos IA", user_label: "Usuario:", nav_dashboard: "Panel", nav_reports: "Reportes", nav_settings: "Ajustes",
                monthly_limit: "LÃ­mite Mensual", edit: "Editar", current_spend: "Gasto Actual", utilization: "UtilizaciÃ³n",
                test_title: "Prueba de Proxy", run_test: "Ejecutar GeneraciÃ³n", report_title: "Generador de Reportes", copy_gamma: "Copiar para Gamma",
                total_invest: "InversiÃ³n Total", est_savings: "Ahorro Est.", eff_score: "Eficiencia", recent_trans: "Transacciones Recientes",
                pro_sub: "SuscripciÃ³n Pro", pro_desc: "Aumenta lÃ­mites y desbloquea anÃ¡lisis.", upgrade_btn: "Mejorar a Pro",
                custom_models: "Modelos Propios (Local)", add_model: "Agregar", set_budget_title: "Definir Presupuesto", cancel: "Cancelar", save: "Guardar"
            },
            pt: {
                app_title: "Guarda de Custos IA", user_label: "UsuÃ¡rio:", nav_dashboard: "Painel", nav_reports: "RelatÃ³rios", nav_settings: "ConfiguraÃ§Ãµes",
                monthly_limit: "Limite Mensal", edit: "Editar", current_spend: "Gasto Atual", utilization: "UtilizaÃ§Ã£o",
                test_title: "Teste de Proxy", run_test: "Executar GeraÃ§Ã£o", report_title: "Gerador de RelatÃ³rios", copy_gamma: "Copiar para Gamma",
                total_invest: "Investimento Total", est_savings: "Economia Est.", eff_score: "EficiÃªncia", recent_trans: "TransaÃ§Ãµes Recentes",
                pro_sub: "Assinatura Pro", pro_desc: "Aumente limites e desbloqueie anÃ¡lises.", upgrade_btn: "Mudar para Pro",
                custom_models: "Modelos Personalizados", add_model: "Adicionar", set_budget_title: "Definir OrÃ§amento", cancel: "Cancelar", save: "Salvar"
            },
            fr: {
                app_title: "Gardien des CoÃ»ts IA", user_label: "Utilisateur:", nav_dashboard: "Tableau de bord", nav_reports: "Rapports", nav_settings: "ParamÃ¨tres",
                monthly_limit: "Limite Mensuelle", edit: "Modifier", current_spend: "DÃ©pense Actuelle", utilization: "Utilisation",
                test_title: "Test Proxy", run_test: "Lancer GÃ©nÃ©ration", report_title: "GÃ©nÃ©rateur de Rapports", copy_gamma: "Copier pour Gamma",
                total_invest: "Investissement Total", est_savings: "Ã‰conomies Est.", eff_score: "EfficacitÃ©", recent_trans: "Transactions RÃ©centes",
                pro_sub: "Abonnement Pro", pro_desc: "Augmentez les limites et dÃ©bloquez l'analytique.", upgrade_btn: "Passer Ã  Pro",
                custom_models: "ModÃ¨les PersonnalisÃ©s", add_model: "Ajouter", set_budget_title: "DÃ©finir Budget", cancel: "Annuler", save: "Sauvegarder"
            }
        };

        // --- 3. UI LOGIC ---
        function switchTab(tabId) {
            ['dashboard', 'reports', 'settings'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`nav-${tabId}`).classList.add('active');
            
            if (tabId === 'reports') renderReports();
            if (tabId === 'settings') fetchCustomModels();
        }

        function changeLanguage(lang) {
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            const promptInput = document.getElementById('prompt-input');
            if(lang === 'es') promptInput.placeholder = "Pregunta algo a la IA...";
            else if(lang === 'pt') promptInput.placeholder = "Pergunte algo Ã  IA...";
            else if(lang === 'fr') promptInput.placeholder = "Demandez quelque chose Ã  l'IA...";
            else promptInput.placeholder = "Ask the AI something...";
        }

        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.className = isError ? 'text-red-400 mb-1' : 'text-green-400 mb-1';
            document.getElementById('console-output').prepend(div);
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- 4. INITIALIZATION ---
        async function init() {
            lucide.createIcons();
            if (SUPABASE_KEY.includes('PASTE_YOUR')) return document.getElementById('config-warning').classList.remove('hidden');

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            userId = localStorage.getItem('acg_uid') || crypto.randomUUID();
            localStorage.setItem('acg_uid', userId);
            document.getElementById('user-id-display').textContent = userId.substring(0,8)+'...';

            await fetchData();
        }

        // --- 5. DATA FETCHING ---
        async function fetchData() {
            const { data: bData } = await supabase.from('budgets').select('budget_limit').eq('customer_id', userId).maybeSingle();
            currentLimit = bData ? bData.budget_limit : 50.00;

            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
            const { data: uData } = await supabase.from('usage_records')
                .select('*')
                .eq('customer_id', userId)
                .gte('created_at', startOfMonth)
                .order('created_at', { ascending: false });
            
            transactions = uData || [];
            totalSpent = transactions.reduce((acc, r) => acc + r.total_cost, 0);

            updateDashboardUI();
        }

        function updateDashboardUI() {
            document.getElementById('budget-display').textContent = `$${currentLimit.toFixed(2)}`;
            document.getElementById('spent-display').textContent = `$${totalSpent.toFixed(2)}`;
            
            const pct = currentLimit > 0 ? Math.min((totalSpent / currentLimit) * 100, 100) : 0;
            const bar = document.getElementById('progress-bar');
            bar.style.width = `${pct}%`;
            bar.className = `h-full transition-all duration-500 ${pct >= 90 ? 'bg-red-600' : 'bg-emerald-500'}`;
            document.getElementById('usage-percent').textContent = `${pct.toFixed(1)}% Used`;
        }

        // --- 6. REPORTS LOGIC ---
        function renderReports() {
            const cacheHits = transactions.filter(t => t.total_cost === 0).length;
            const estSavings = cacheHits * 0.10; 
            const hitRate = transactions.length > 0 ? (cacheHits / transactions.length) * 100 : 0;

            document.getElementById('report-total').textContent = `$${totalSpent.toFixed(2)}`;
            document.getElementById('report-savings').textContent = `$${estSavings.toFixed(2)}`;
            document.getElementById('report-efficiency').textContent = `${hitRate.toFixed(1)}%`;

            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = transactions.slice(0, 5).map(t => `
                <tr class="border-b border-gray-700">
                    <td class="px-4 py-3">${new Date(t.created_at).toLocaleDateString()}</td>
                    <td class="px-4 py-3">${t.model_name}</td>
                    <td class="px-4 py-3 text-right text-emerald-400">$${t.total_cost.toFixed(4)}</td>
                </tr>
            `).join('');
        }

        async function generateGammaReport() {
            const reportText = `
# Monthly AI Report for User ${userId.substring(0,6)}

## ðŸ’° Financial Overview
- **Total Investment:** $${totalSpent.toFixed(2)}
- **Cost Savings:** $${(transactions.filter(t => t.total_cost === 0).length * 0.10).toFixed(2)} (realized via caching)

## âš¡ Performance
- **Efficiency Score:** ${(transactions.length > 0 ? (transactions.filter(t => t.total_cost === 0).length / transactions.length * 100) : 0).toFixed(1)}%
- **Total Transactions:** ${transactions.length}

## ðŸ“‰ Insight
AI Cost Guard actively monitored your budget of $${currentLimit.toFixed(2)}.
`.trim();
            
            try {
                await navigator.clipboard.writeText(reportText);
                alert("Report copied! Paste into Gamma.app 'Generate from notes'.");
            } catch (err) {
                alert("Failed to copy: " + err);
            }
        }

        // --- 7. CUSTOM MODELS LOGIC ---
        async function fetchCustomModels() {
            const { data } = await supabase.from('custom_models').select('*').eq('customer_id', userId);
            const list = document.getElementById('custom-models-list');
            list.innerHTML = (data || []).map(m => `
                <div class="flex justify-between bg-gray-800 p-3 rounded border border-gray-600 items-center">
                    <div>
                        <p class="font-bold">${m.model_name}</p>
                        <p class="text-xs text-gray-400">$${m.cost_rate} / ${m.unit_type}</p>
                    </div>
                    <button class="text-red-400 text-xs hover:text-red-300">Remove</button>
                </div>
            `).join('') || '<p class="text-gray-500 text-sm">No custom models yet.</p>';
        }

        async function addCustomModel() {
            const name = document.getElementById('model-name').value;
            const rate = parseFloat(document.getElementById('model-rate').value);
            
            if (!name || !rate) return alert("Invalid input");

            const { error } = await supabase.from('custom_models').insert({
                customer_id: userId,
                model_name: name,
                cost_rate: rate,
                unit_type: 'request'
            });

            if (error) alert("Error: " + error.message);
            else {
                document.getElementById('model-name').value = '';
                document.getElementById('model-rate').value = '';
                fetchCustomModels();
            }
        }

        // --- 8. STRIPE LOGIC ---
        function redirectToStripe() {
            if (STRIPE_LINK.includes('PASTE')) {
                alert("Please configure the Stripe Payment Link in the code!");
                return;
            }
            window.open(STRIPE_LINK, '_blank');
        }

        // --- 9. ACTIONS ---
        async function saveBudget() {
            const val = parseFloat(document.getElementById('new-budget-input').value);
            if (!val || val <= 0) return;
            closeModal('budget-modal');
            await supabase.from('budgets').upsert({ customer_id: userId, budget_limit: val, updated_at: new Date() }, { onConflict: 'customer_id' });
            await fetchData();
        }

        async function runProxyTest() {
            const prompt = document.getElementById('prompt-input').value;
            const btn = document.getElementById('btn-run-test');
            btn.disabled = true; btn.textContent = "Running...";
            log("Calling AI Proxy...");

            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                    body: JSON.stringify({ customerId: userId, prompt: prompt })
                });
                const data = await res.json();
                
                if (res.status === 403) {
                    log(`ðŸ›‘ BLOCKED: ${data.error}`, true);
                } else if (res.ok) {
                    log(`âœ… SUCCESS! Cost: $${data.cost}`);
                    log(`Output: "${data.output}"`); 
                    await fetchData(); // Refresh UI
                } else {
                    log(`Error: ${data.error}`, true);
                }
            } catch (e) {
                log(`Network Error: ${e.message}`, true);
            } finally {
                btn.disabled = false; btn.textContent = "Run Generation";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
