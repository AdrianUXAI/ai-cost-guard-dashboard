<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cost Guard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: #1f2937; }
        body::-webkit-scrollbar-thumb { background: #059669; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen bg-gray-900 p-4 sm:p-8 text-white">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <header class="max-w-4xl mx-auto mb-8">
        <h1 class="text-4xl font-extrabold text-emerald-400 mb-2">AI Cost Guard</h1>
        <p class="text-gray-400">
            User ID: <span id="user-id" class="font-mono text-xs p-1 bg-gray-800 rounded">...Loading...</span>
        </p>
        <p id="config-warning" class="text-sm text-red-400 mt-2 font-bold hidden">
            ðŸš¨ ACTION REQUIRED: Please edit the file and fill in the SUPABASE_URL and SUPABASE_ANON_KEY!
        </p>
    </header>

    <main class="max-w-4xl mx-auto bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700">
        
        <div class="bg-gray-900 border-l-4 border-emerald-500 p-4 mb-8 rounded-lg">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm font-medium text-emerald-300">Monthly Budget Limit:</p>
                    <h2 id="current-budget-display" class="text-3xl font-bold text-emerald-400">Not Set</h2>
                </div>
                <button id="open-modal-btn" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-full hover:bg-emerald-700 transition duration-150 shadow-md disabled:bg-gray-600" disabled>
                    Set Budget
                </button>
            </div>
            <div class="mt-4">
                <p class="text-xs text-gray-300 font-medium">Spent This Month: <span id="total-spent-display" class="font-bold">$0.00</span></p>
                <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="usage-percent-text" class="text-xs text-right mt-1 text-gray-300">0.0% Used</p>
                <p id="budget-exceeded-warning" class="text-red-400 text-sm font-semibold mt-2 hidden">Budget is exceeded! API calls will be blocked.</p>
            </div>
        </div>

        <section class="mt-10">
            <h3 class="text-xl font-semibold text-white mb-4">Test AI Proxy (Cache & Cost Check)</h3>
            <p class="text-gray-400 mb-4">Click below to simulate a call to your Edge Function. It will check your budget first.</p>
            <button id="run-proxy-test-btn" class="w-full sm:w-auto px-6 py-3 text-lg font-semibold text-gray-900 bg-sky-400 rounded-xl hover:bg-sky-500 transition duration-200 shadow-lg disabled:bg-gray-600" disabled>
                Run AI Content Generation Test
            </button>
            <div id="proxy-message" class="mt-4 p-3 rounded-lg text-sm font-mono bg-gray-700 text-emerald-300">Awaiting test run...</div>
        </section>
    </main>

    <div id="budget-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Set Monthly Budget</h2>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">New Monthly Limit ($USD)</label>
                <input id="budget-input" type="number" step="0.01" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg text-lg text-gray-900" value="50.00" />
            </div>
            <div id="modal-message" class="h-6 text-sm text-center text-red-600"></div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-modal-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-modal-btn" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">Save Budget</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://tsogjfhrvzuweshlfrfu.supabase.co"; 
        const SUPABASE_ANON_KEY = "e43a37db2c2fd34f63b7d7ced9c8595c8454b0c47449e"; 
        const PROXY_URL = "https://tsogjfhrvzuweshlfrfu.supabase.co/functions/v1/budget-guard"; 
        // -------------------------------------------

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let supabaseClient, auth, userId = null;

        // UI Elements
        const els = {
            userId: document.getElementById('user-id'),
            budgetDisplay: document.getElementById('current-budget-display'),
            spentDisplay: document.getElementById('total-spent-display'),
            progressBar: document.getElementById('progress-bar'),
            percentText: document.getElementById('usage-percent-text'),
            warning: document.getElementById('budget-exceeded-warning'),
            openBtn: document.getElementById('open-modal-btn'),
            runBtn: document.getElementById('run-proxy-test-btn'),
            proxyMsg: document.getElementById('proxy-message'),
            modal: document.getElementById('budget-modal'),
            input: document.getElementById('budget-input'),
            modalMsg: document.getElementById('modal-message'),
            saveBtn: document.getElementById('save-modal-btn'),
            cancelBtn: document.getElementById('cancel-modal-btn'),
            configWarn: document.getElementById('config-warning')
        };

        async function init() {
            // 1. Check Config
            if (SUPABASE_URL.includes("PASTE") || SUPABASE_ANON_KEY.includes("PASTE")) {
                els.configWarn.classList.remove('hidden');
                return;
            }

            // 2. Init Supabase
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }

            // 3. Init Firebase Auth (Simplified)
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = crypto.randomUUID();
                            signInAnonymously(auth);
                        }
                        els.userId.textContent = userId;
                        els.openBtn.disabled = false;
                        els.runBtn.disabled = false;
                        updateUI();
                    });
                    if (initialAuthToken) signInWithCustomToken(auth, initialAuthToken);
                    else signInAnonymously(auth);
                } else {
                    // Fallback if no firebase config
                    userId = localStorage.getItem('acg_user') || crypto.randomUUID();
                    localStorage.setItem('acg_user', userId);
                    els.userId.textContent = userId;
                    els.openBtn.disabled = false;
                    els.runBtn.disabled = false;
                    updateUI();
                }
            } catch (e) { console.error(e); }
        }

        async function updateUI() {
            if (!userId || !supabaseClient) return;

            // Fetch Budget (using correct column 'budget_limit')
            const { data: bData } = await supabaseClient
                .from('budgets')
                .select('budget_limit') // <--- CORRECTED COLUMN NAME
                .eq('customer_id', userId)
                .maybeSingle();
            
            const limit = bData ? bData.budget_limit : null;

            // Fetch Spend
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
            const { data: uData } = await supabaseClient
                .from('usage_records')
                .select('total_cost')
                .eq('customer_id', userId)
                .gte('created_at', startOfMonth);
            
            const spent = uData ? uData.reduce((sum, r) => sum + r.total_cost, 0) : 0;

            // Render
            els.spentDisplay.textContent = `$${spent.toFixed(2)}`;
            if (limit !== null) {
                els.budgetDisplay.textContent = `$${limit.toFixed(2)}`;
                els.input.value = limit.toFixed(2);
                const pct = Math.min(100, (spent / limit) * 100);
                els.progressBar.style.width = `${pct}%`;
                els.percentText.textContent = `${pct.toFixed(1)}% Used`;
                els.progressBar.className = `h-2.5 rounded-full transition-all duration-300 ${pct >= 90 ? 'bg-red-500' : 'bg-emerald-600'}`;
                if (pct >= 100) els.warning.classList.remove('hidden');
                else els.warning.classList.add('hidden');
            } else {
                els.budgetDisplay.textContent = 'Not Set';
            }
        }

        async function saveBudget() {
            const val = parseFloat(els.input.value);
            if (!val || val <= 0) return;
            els.saveBtn.disabled = true;
            els.modalMsg.textContent = "Saving...";

            // Upsert using correct column 'budget_limit'
            const { error } = await supabaseClient
                .from('budgets')
                .upsert({ 
                    customer_id: userId, 
                    budget_limit: val, // <--- CORRECTED COLUMN NAME
                    updated_at: new Date() 
                }, { onConflict: 'customer_id' });

            if (error) {
                els.modalMsg.textContent = "Error: " + error.message;
            } else {
                els.modalMsg.textContent = "Saved!";
                await updateUI();
                setTimeout(() => els.modal.classList.add('hidden'), 1000);
            }
            els.saveBtn.disabled = false;
        }

        async function runProxy() {
            if (PROXY_URL.includes('YOUR_')) return;
            els.runBtn.disabled = true;
            els.proxyMsg.textContent = "Running...";
            
            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        customerId: userId,
                        workflowId: "test-ui",
                        modelName: "gemini-2.5-flash",
                        prompt: "Test prompt for budget check"
                    })
                });
                const data = await res.json();
                if (res.status === 403) {
                    els.proxyMsg.className = "mt-4 p-3 rounded-lg text-sm font-mono bg-orange-900 text-orange-200";
                    els.proxyMsg.textContent = `ðŸ›‘ BLOCKED: ${data.error}`;
                } else if (res.ok) {
                    els.proxyMsg.className = "mt-4 p-3 rounded-lg text-sm font-mono bg-gray-700 text-emerald-300";
                    els.proxyMsg.textContent = `âœ… SUCCESS! Cost: $${data.cost} | Cached: ${data.cached}`;
                    await updateUI();
                } else {
                    throw new Error(data.error || res.statusText);
                }
            } catch (e) {
                els.proxyMsg.className = "mt-4 p-3 rounded-lg text-sm font-mono bg-red-900 text-red-200";
                els.proxyMsg.textContent = "Error: " + e.message;
            } finally {
                els.runBtn.disabled = false;
            }
        }

        els.openBtn.onclick = () => { els.modal.classList.remove('hidden'); els.modalMsg.textContent = ''; };
        els.cancelBtn.onclick = () => els.modal.classList.add('hidden');
        els.saveBtn.onclick = saveBudget;
        els.runBtn.onclick = runProxy;
        window.onload = init;
    </script>
</body>
</html>
