<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cost Guard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: sans-serif; background-color: #111827; color: white; }
    </style>
</head>
<body class="p-6">

    <!-- MAIN CONTAINER -->
    <div class="max-w-4xl mx-auto">
        
        <!-- HEADER -->
        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-emerald-400">AI Cost Guard</h1>
            <p class="text-gray-400 mt-1">User ID: <span id="user-id-display" class="font-mono text-yellow-200">Loading...</span></p>
        </header>

        <!-- STATUS CARD -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 mb-8">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">Monthly Budget Status</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <p class="text-sm text-gray-400">Limit</p>
                    <p id="budget-limit-display" class="text-2xl font-bold text-white">---</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-400">Spent</p>
                    <p id="total-spent-display" class="text-2xl font-bold text-white">---</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-700 rounded-full h-4 mb-2">
                <div id="progress-bar" class="bg-emerald-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="usage-percent-text" class="text-xs text-right text-gray-400">0% Used</p>

            <button id="btn-open-modal" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded">
                Set New Budget
            </button>
        </div>

        <!-- TEST CARD -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-semibold text-gray-300 mb-4">Test AI Proxy</h2>
            <p class="text-gray-400 text-sm mb-4">This button sends a request to your Edge Function to generate text. It will check your budget first.</p>
            
            <button id="btn-run-test" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
                Run AI Generation Test
            </button>

            <div id="console-output" class="mt-4 p-3 bg-black rounded font-mono text-xs text-green-400 min-h-[50px]">
                System Ready. Waiting for action...
            </div>
        </div>

    </div>

    <!-- BUDGET MODAL (Hidden by default) -->
    <div id="budget-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md border border-gray-600">
            <h3 class="text-xl font-bold mb-4">Update Monthly Limit</h3>
            <input type="number" id="input-budget" class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded text-white" placeholder="Enter amount (e.g. 50.00)">
            <div class="flex justify-end gap-2">
                <button id="btn-cancel-modal" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded">Cancel</button>
                <button id="btn-save-budget" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-4 rounded">Save</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. CONFIGURATION (FILL THESE IN!) ---
        const SUPABASE_URL = "37dd2ec8a59ae31b084d41546965f588392ceb51ca1e2";
        const SUPABASE_KEY = "e43a37db2c2fd34f63b7d7ced9c8595c8454b0c47449e";
        const PROXY_URL = "https://tsogjfhrvzuweshlfrfu.supabase.co/functions/v1/budget-guard";

        // --- 2. APP STATE ---
        let supabase;
        let userId;
        let currentBudget = 0;

        // Helper to log to our fake console
        function log(msg, isError = false) {
            const el = document.getElementById('console-output');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            if (isError) line.style.color = '#ff6b6b';
            el.appendChild(line);
            console.log(msg);
        }

        // --- 3. INITIALIZATION ---
        async function init() {
            // Check Config
            if (SUPABASE_URL.includes('YOUR_') || SUPABASE_KEY.includes('YOUR_')) {
                log("ERROR: Supabase Configuration missing in code!", true);
                alert("Please edit index.html and add your Supabase URL and Key.");
                return;
            }

            // Init Supabase
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log("Supabase Client Initialized.");
            } catch (err) {
                log("Failed to init Supabase: " + err.message, true);
                return;
            }

            // Simulate Auth (Get or Create User ID)
            userId = localStorage.getItem('ai_cost_guard_user');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('ai_cost_guard_user', userId);
            }
            document.getElementById('user-id-display').textContent = userId;
            log("User Logged In: " + userId);

            // Load Data
            await fetchDashboardData();
        }

        // --- 4. DATA FETCHING ---
        async function fetchDashboardData() {
            log("Fetching budget & usage...");
            
            // A. Get Budget
            const { data: budgetData, error: budgetError } = await supabase
                .from('budgets')
                .select('limit')
                .eq('customer_id', userId)
                .maybeSingle();

            if (budgetError) {
                log("Error fetching budget: " + budgetError.message, true);
            }
            
            currentBudget = budgetData ? budgetData.limit : 0;
            document.getElementById('budget-limit-display').textContent = `$${currentBudget.toFixed(2)}`;

            // B. Get Usage (Sum of total_cost)
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
            const { data: usageData, error: usageError } = await supabase
                .from('usage_records')
                .select('total_cost')
                .eq('customer_id', userId)
                .gte('created_at', startOfMonth);

            let totalSpent = 0;
            if (!usageError && usageData) {
                totalSpent = usageData.reduce((acc, curr) => acc + curr.total_cost, 0);
            }

            // Update UI
            document.getElementById('total-spent-display').textContent = `$${totalSpent.toFixed(2)}`;
            
            // Progress Bar
            let percent = currentBudget > 0 ? (totalSpent / currentBudget) * 100 : 0;
            if (percent > 100) percent = 100;
            
            const bar = document.getElementById('progress-bar');
            document.getElementById('usage-percent-text').textContent = `${percent.toFixed(1)}% Used`;
            bar.style.width = `${percent}%`;
            
            if (percent >= 100) bar.classList.replace('bg-emerald-500', 'bg-red-600');
            else if (percent > 80) bar.classList.replace('bg-emerald-500', 'bg-yellow-500');
            else bar.className = "bg-emerald-500 h-4 rounded-full transition-all duration-500";

            log("Dashboard Updated.");
        }

        // --- 5. ACTIONS ---
        
        // Save Budget
        async function saveBudget() {
            const val = parseFloat(document.getElementById('input-budget').value);
            if (!val || val <= 0) return alert("Invalid amount");

            log("Saving budget...");
            const { error } = await supabase
                .from('budgets')
                .upsert({ customer_id: userId, limit: val, updated_at: new Date() }, { onConflict: 'customer_id' });

            if (error) {
                log("Save failed: " + error.message, true);
            } else {
                log("Budget saved!");
                toggleModal(false);
                fetchDashboardData();
            }
        }

        // Run Proxy Test
        async function runTest() {
            if (PROXY_URL.includes('YOUR_')) {
                return alert("Please configure PROXY_URL in the code.");
            }
            
            log("Sending request to AI Proxy...");
            document.getElementById('btn-run-test').disabled = true;
            document.getElementById('btn-run-test').textContent = "Running...";

            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: userId,
                        workflowId: "test-run",
                        modelName: "gemini-2.5-flash",
                        prompt: "Explain how semantic caching saves money."
                    })
                });

                const data = await res.json();
                
                if (res.status === 403) {
                    log(`ðŸ›‘ BLOCKED: ${data.error}`, true);
                } else if (!res.ok) {
                    log(`âŒ ERROR: ${data.error || res.statusText}`, true);
                } else {
                    log(`âœ… SUCCESS! Cached: ${data.cached}. Cost: $${data.cost}`);
                    log(`Output: ${data.output.substring(0, 40)}...`);
                    // Refresh dashboard to show new spend
                    setTimeout(fetchDashboardData, 1000);
                }

            } catch (e) {
                log("Network Error: " + e.message, true);
            } finally {
                document.getElementById('btn-run-test').disabled = false;
                document.getElementById('btn-run-test').textContent = "Run AI Generation Test";
            }
        }

        // --- 6. EVENT LISTENERS ---
        function toggleModal(show) {
            const modal = document.getElementById('budget-modal');
            if (show) modal.classList.remove('hidden');
            else modal.classList.add('hidden');
        }

        document.getElementById('btn-open-modal').onclick = () => toggleModal(true);
        document.getElementById('btn-cancel-modal').onclick = () => toggleModal(false);
        document.getElementById('btn-save-budget').onclick = saveBudget;
        document.getElementById('btn-run-test').onclick = runTest;

        // Start
        window.onload = init;

    </script>
</body>
</html>
